<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图修复验证测试</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .test-header {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .test-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .test-content {
            padding: 16px;
        }
        .map-container {
            height: 400px;
            width: 100%;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .status-error {
            background-color: #dc3545;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .coord-display {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>地图修复验证测试</h1>
        <p>此页面用于验证地图拼接错乱和对角图片加载问题的修复效果。</p>
        
        <div class="test-grid">
            <!-- 测试1: 基础地图显示 -->
            <div class="test-card">
                <div class="test-header">
                    <h3 class="test-title">
                        <span class="status-indicator status-success"></span>
                        基础地图显示测试
                    </h3>
                </div>
                <div class="test-content">
                    <p>验证地图是否正确铺满容器，无白色背景或对角线图案。</p>
                    <div id="map1" class="map-container"></div>
                    <div class="coord-display" id="coords1">等待地图加载...</div>
                </div>
            </div>

            <!-- 测试2: 边界限制测试 -->
            <div class="test-card">
                <div class="test-header">
                    <h3 class="test-title">
                        <span class="status-indicator status-success"></span>
                        边界限制测试
                    </h3>
                </div>
                <div class="test-content">
                    <p>验证地图是否正确限制在世界范围内，防止瓦片重复。</p>
                    <div id="map2" class="map-container"></div>
                    <div class="coord-display" id="coords2">等待地图加载...</div>
                </div>
            </div>

            <!-- 测试3: 坐标标准化测试 -->
            <div class="test-card">
                <div class="test-header">
                    <h3 class="test-title">
                        <span class="status-indicator status-success"></span>
                        坐标标准化测试
                    </h3>
                </div>
                <div class="test-content">
                    <p>验证超出范围的坐标是否被正确标准化。</p>
                    <div id="map3" class="map-container"></div>
                    <div class="coord-display" id="coords3">等待地图加载...</div>
                </div>
            </div>

            <!-- 测试4: 响应式布局测试 -->
            <div class="test-card">
                <div class="test-header">
                    <h3 class="test-title">
                        <span class="status-indicator status-success"></span>
                        响应式布局测试
                    </h3>
                </div>
                <div class="test-content">
                    <p>验证地图在不同容器尺寸下是否正确渲染。</p>
                    <div id="map4" class="map-container"></div>
                    <div class="coord-display" id="coords4">等待地图加载...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 坐标标准化函数
        function normalizeLongitude(lng) {
            const normalized = lng % 360;
            return normalized > 180 ? normalized - 360 : normalized;
        }

        function normalizeLatitude(lat) {
            return Math.max(-90, Math.min(90, lat));
        }

        // 创建地图的通用函数
        function createMap(containerId, center, zoom, options = {}) {
            const mapOptions = {
                center: center,
                zoom: zoom,
                worldCopyJump: false,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0,
                minZoom: 1,
                maxZoom: 18,
                zoomControl: false,
                attributionControl: false,
                ...options
            };

            const map = L.map(containerId, mapOptions);
            
            // 添加瓦片层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors | 显示坐标: WGS84',
                noWrap: true,
                updateWhenIdle: false,
                updateWhenZooming: true,
                keepBuffer: 4,
                bounds: [[-90, -180], [90, 180]],
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0
            }).addTo(map);

            // 添加比例尺
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false,
                maxWidth: 200
            }).addTo(map);

            // 添加坐标显示
            map.on('mousemove', function(e) {
                const coords = `WGS84坐标: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
                document.getElementById(containerId.replace('map', 'coords')).textContent = coords;
            });

            return map;
        }

        // 测试1: 基础地图显示
        setTimeout(() => {
            const map1 = createMap('map1', [31.2000, 121.5000], 6);
            
            // 验证地图容器尺寸
            const container = document.getElementById('map1');
            const rect = container.getBoundingClientRect();
            console.log('Map1 container size:', rect);
            
            // 添加标记
            L.marker([31.2000, 121.5000])
                .addTo(map1)
                .bindPopup('上海 - 基础测试点')
                .openPopup();
        }, 100);

        // 测试2: 边界限制测试
        setTimeout(() => {
            const map2 = createMap('map2', [0, 0], 2);
            
            // 尝试设置超出边界的中心点（应该被限制）
            map2.setMaxBounds([[-90, -180], [90, 180]]);
            
            // 添加边界标记
            L.marker([85, 170]).addTo(map2).bindPopup('东北边界');
            L.marker([-85, -170]).addTo(map2).bindPopup('西南边界');
            L.marker([0, 179]).addTo(map2).bindPopup('东边界');
            L.marker([0, -179]).addTo(map2).bindPopup('西边界');
        }, 200);

        // 测试3: 坐标标准化测试
        setTimeout(() => {
            const problemCoords = [
                { name: '问题坐标1', lat: -88.032349, lng: -326.667414 },
                { name: '问题坐标2', lat: 45.5, lng: 400.0 },
                { name: '问题坐标3', lat: 95.0, lng: -200.0 }
            ];

            const map3 = createMap('map3', [0, 0], 2);
            
            problemCoords.forEach(coord => {
                const normalizedLat = normalizeLatitude(coord.lat);
                const normalizedLng = normalizeLongitude(coord.lng);
                
                L.marker([normalizedLat, normalizedLng])
                    .addTo(map3)
                    .bindPopup(`
                        <strong>${coord.name}</strong><br>
                        原始: ${coord.lat}, ${coord.lng}<br>
                        标准化: ${normalizedLat.toFixed(6)}, ${normalizedLng.toFixed(6)}
                    `);
            });
        }, 300);

        // 测试4: 响应式布局测试
        setTimeout(() => {
            const map4 = createMap('map4', [31.2000, 121.5000], 4);
            
            // 添加多个标记点
            const cities = [
                { name: '上海', lat: 31.2000, lng: 121.5000 },
                { name: '北京', lat: 39.9042, lng: 116.4074 },
                { name: '纽约', lat: 40.7128, lng: -74.0060 },
                { name: '伦敦', lat: 51.5074, lng: -0.1278 }
            ];
            
            cities.forEach(city => {
                L.marker([city.lat, city.lng])
                    .addTo(map4)
                    .bindPopup(city.name);
            });
            
            // 模拟容器尺寸变化
            setTimeout(() => {
                const container = document.getElementById('map4');
                container.style.height = '300px';
                setTimeout(() => {
                    map4.invalidateSize();
                    console.log('Map4 resized to 300px');
                }, 100);
            }, 2000);
        }, 400);

        // 页面加载完成后的验证
        window.addEventListener('load', function() {
            console.log('页面加载完成，开始验证地图修复效果...');
            
            // 检查所有地图容器
            ['map1', 'map2', 'map3', 'map4'].forEach(mapId => {
                const container = document.getElementById(mapId);
                if (container) {
                    const rect = container.getBoundingClientRect();
                    console.log(`${mapId} container:`, rect);
                    
                    // 检查是否有白色背景或异常显示
                    const leafletContainer = container.querySelector('.leaflet-container');
                    if (leafletContainer) {
                        const style = window.getComputedStyle(leafletContainer);
                        console.log(`${map1} leaflet container background:`, style.backgroundColor);
                    }
                }
            });
        });
    </script>
</body>
</html>